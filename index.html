<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="1분 CPX">
    <meta name="author" content="KNU FM JSW">
    <meta name="description" content="의사 국가고시 실기(CPX) 대비를 위한 1분 타이머 및 케이스 스터디 웹앱.">
    <meta property="og:title" content="1분 CPX - 실기시험 순발력 훈련">
    <meta property="og:description" content="C.C를 보고 1분 안에 연상하는 실전 감각 연습. 제작: KNU FM JSW">

    <title>1분 CPX v1.2</title>
    
    
    <link rel="apple-touch-icon" href="icon.PNG">
    <link rel="icon" type="image/png" href="icon.PNG">
    
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #334155;
            --primary-color: #2563eb;
            --timer-bg: #fff7ed;
            --timer-text: #c2410c;
            --timer-border: #fed7aa;
            --header-height: 60px;
            --box-bg: #f1f5f9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: "Pretendard", "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; flex-direction: column;
            height: 100vh; height: 100dvh; overflow: hidden; user-select: none;
        }

        .container {
            max-width: 500px; margin: 0 auto; width: 100%; height: 100%;
            background-color: white; display: flex; flex-direction: column; position: relative;
        }

        /* ✅ [수정됨] 파스텔 톤 형광펜 버튼 스타일 */
        .hl-btn {
            width: 24px; 
            height: 24px;
            border-radius: 4px; /* 약간 둥근 사각형 */
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1); /* 은은한 테두리 */
            margin-left: 4px;
            transition: transform 0.1s, border-color 0.1s;
        }
        .hl-btn:active { transform: scale(0.9); }
        
        /* 노란색 버튼 (파스텔) */
        .hl-btn.yellow { 
            background-color: #fff9c4; /* 연한 노랑 */
            border-color: #fbc02d;     /* 진한 노랑 테두리 */
        }
        /* 연두색 버튼 (파스텔) */
        .hl-btn.green { 
            background-color: #dcedc8; /* 연한 연두 */
            border-color: #8bc34a;     /* 진한 연두 테두리 */
        }

        /* HEADER */
        header {
            padding: 0 1rem; padding-top: env(safe-area-inset-top);
            border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
            background-color: white; z-index: 10; height: calc(var(--header-height) + env(safe-area-inset-top));
        }
        
        .header-left { display: flex; align-items: center; gap: 0.8rem; }
        .brand-box { display: flex; flex-direction: column; justify-content: center; cursor: pointer; }
        .main-title { 
            font-weight: 900; 
            font-size: 1rem;       /* 1. 폰트 크기 축소 (1.1rem -> 1rem) */
            color: #1e293b; 
            letter-spacing: -0.5px;
            white-space: nowrap;   /* 2. 줄바꿈 강제 방지 (핵심) */
        }
        .sub-title { font-weight: 700; font-size: 0.65rem; color: var(--primary-color); letter-spacing: 0.5px; }

        .timer-badge {
            display: flex; align-items: center; gap: 0.3rem;
            background-color: var(--timer-bg); padding: 0.3rem 0.6rem; border-radius: 99px;
            font-size: 0.9rem; font-weight: 800; color: var(--timer-text); 
            cursor: pointer; border: 1px solid var(--timer-border); transition: 0.3s;
        }
        .timer-badge:active { transform: scale(0.95); }
        .timer-badge.urgent {
            background-color: #fee2e2; color: #ef4444; border-color: #fca5a5;
            animation: heartBeat 1s infinite;
        }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.1); }
            30% { transform: scale(1); }
            45% { transform: scale(1.1); }
            60% { transform: scale(1); }
        }

        .header-controls { display: flex; gap: 0.3rem; align-items: center; }
        .header-btn {
            background: none; border: none; padding: 0.5rem; cursor: pointer; color: #94a3b8;
            border-radius: 8px; font-weight: 700; font-size: 0.85rem;
            display: flex; align-items: center; gap: 0.3rem;
            
            /* ✅ 핵심 수정: PC에서도 절대 줄바꿈 금지 & 찌그러짐 방지 */
            white-space: nowrap; 
            flex-shrink: 0;
        }
        .header-btn svg { width: 1.1rem; height: 1.1rem; stroke-width: 2.5; }
        .header-btn.active { color: var(--primary-color); background: #eff6ff; }
        
        .icon-control-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #cbd5e1; cursor: pointer;
            transition: 0.2s;
        }
        .icon-control-btn.active { background: #eff6ff; color: var(--primary-color); border-color: #bfdbfe; }
        .icon-control-btn:active { transform: scale(0.95); }
        .icon-control-btn svg { width: 1.3rem; height: 1.3rem; }

        /* VIEW CONTAINERS */
        .view-section { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; background: #f8fafc; }
        .view-section.active { display: flex; }

        /* STUDY VIEW */
        .progress-bar-area { width: 100%; height: 4px; background: #e2e8f0; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .progress-float { 
            position: absolute; top: 1rem; right: 1.5rem; font-size: 0.8rem; 
            font-weight: 800; color: #cbd5e1; z-index: 5;
        }

        .card-area {
            flex: 1; padding: 1.5rem; display: flex; align-items: center; justify-content: center;
            perspective: 1000px; position: relative;
        }
        
        /* SHAKE ANIMATION */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .shaking {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        .card-wrapper {
            width: 100%; height: 100%; max-height: 680px; position: relative;
            transform-style: preserve-3d; transition: transform 0.4s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        .card-wrapper.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 20px; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #e2e8f0; background: white;
        }

        /* FRONT SIDE */
        .card-front { 
            padding: 2rem; z-index: 2; display: flex; flex-direction: column; gap: 1.2rem; align-items: flex-start; 
            overflow-y: auto;
        }
        
        .topic-badge {
            display: inline-block; padding: 6px 14px; background: #eff6ff; color: #2563eb;
            border-radius: 20px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.5rem;
        }

        .info-box {
            width: 100%; background-color: var(--box-bg); border-radius: 12px; padding: 1.2rem;
            display: flex; flex-direction: column; gap: 0.5rem; border: 1px solid #e2e8f0;
        }

        .info-label { font-size: 0.8rem; font-weight: 800; color: #64748b; margin-bottom: 0.2rem; }
        .info-content { font-size: 1.15rem; font-weight: 700; color: #1e293b; line-height: 1.5; word-break: keep-all; }

        .vitals-container { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .vital-item { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; flex: 1; }
        .vital-label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; }
        .vital-value { font-size: 1.1rem; font-weight: 800; color: #334155; }
        .vital-item:not(:last-child) { border-right: 1px solid #e2e8f0; }

        .instruction-list { padding-left: 1.2rem; margin: 0; font-size: 1rem; font-weight: 500; color: #475569; line-height: 1.6; }
        .instruction-list li { margin-bottom: 4px; }
        .instruction-list li.hybrid-skill { color: #2563eb; font-weight: 700; background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

        .touch-hint {
            margin-top: auto; width: 100%; text-align: center; color: #94a3b8;
            font-size: 0.85rem; font-weight: 600; padding-top: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 0.3rem;
        }
        @media (max-width: 768px) { .pc-hint { display: none; } }

        /* BACK SIDE */
        .card-back { background: #fff; transform: rotateY(180deg); display: flex; flex-direction: column; }
        
        .back-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9; background: #fff;
        }
        .nav-btn {
            background: #f1f5f9; border: none; border-radius: 8px; 
            padding: 0.5rem 0.8rem; font-size: 0.9rem; font-weight: 700; color: #475569;
            display: flex; align-items: center; gap: 0.3rem; cursor: pointer;
        }
        .tool-btns { display: flex; gap: 0.5rem; }
        .icon-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 1px solid #e2e8f0; color: #64748b;
            background: white; cursor: pointer;
        }
        .icon-btn.delete { color: #ef4444; background: #fef2f2; border-color: #fee2e2; }

        .cpx-form { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .field-group { border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; }
        .field-header { display: flex; align-items: center; cursor: pointer; padding: 0.5rem 0; }
        .field-label { width: 50px; font-size: 0.95rem; font-weight: 800; color: var(--primary-color); flex-shrink: 0; }
        .field-key { flex: 1; font-size: 1rem; font-weight: 600; color: #1e293b; }
        .field-key.empty { color: #cbd5e1; font-weight: 400; font-size: 0.9rem; }
        .explanation-box {
            background: #f8fafc; padding: 1rem; border-radius: 8px; margin-left: 50px; margin-bottom: 0.5rem;
            font-size: 0.95rem; line-height: 1.6; color: #334155; display: none; cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .explanation-box.show { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* CONTROLS (FOOTER) */
        .controls { 
            padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid #e2e8f0; background: white; z-index: 20;
        }
        
        .nav-row { display: flex; gap: 0.8rem; align-items: center; width: 100%; }
        .btn {
            border-radius: 12px; font-size: 1.1rem; font-weight: 700;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            background: var(--primary-color); color: white; transition: 0.2s; padding: 1rem;
        }
        .btn-nav { width: 3.5rem; flex-shrink: 0; background: #f1f5f9; color: #64748b; font-size: 1.2rem; }
        .btn-nav:active { background: #e2e8f0; transform: scale(0.95); }
        .btn-main { flex: 1; }
        .btn-red { background: #fee2e2; color: #b91c1c; }
        .btn-green { background: #dcfce7; color: #166534; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; width: 100%; }

        /* MANAGER VIEW */
        .list-container { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 6rem; }
        .list-action-bar { 
            padding: 0.8rem 1rem; background: #fff; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem;
        }
        .category-section { margin-bottom: 1rem; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .category-header {
            padding: 1rem; font-weight: 700; color: #334155; font-size: 1rem;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff;
        }
        .category-header:active { background: #f8fafc; }
        .category-list { display: block; border-top: 1px solid #f1f5f9; }
        .category-list.collapsed { display: none; }
        
        .list-item {
            padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item.hidden .title { color: #94a3b8; text-decoration: line-through; }
        .item-left { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px; font-weight: 600; color: #334155; }
        .item-right { display: flex; align-items: center; gap: 0.8rem; flex-shrink: 0; }
        
        .score-badge { 
            font-size: 0.8rem; font-weight: 800; padding: 4px 8px; border-radius: 8px; 
            min-width: 30px; text-align: center;
        }
        .score-green { background: #dcfce7; color: #166534; }
        .score-yellow { background: #fef9c3; color: #854d0e; }
        .score-red { background: #fee2e2; color: #b91c1c; }
        .score-gray { background: #f1f5f9; color: #94a3b8; }

        .list-actions { display: flex; gap: 0.3rem; }
        .icon-action-btn {
            background: none; border: 1px solid #e2e8f0; border-radius: 8px;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #94a3b8;
        }
        .icon-action-btn.active { background: #eff6ff; color: var(--primary-color); border-color: var(--primary-color); }
        .icon-action-btn.edit { color: #64748b; background: #f8fafc; }

        .manager-controls {
            display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 0.5rem; 
            padding-top: 1rem; border-top: 1px solid #e2e8f0; margin-top: 1rem;
        }
        .btn-blue-outline { background: white; border: 1px solid #bfdbfe; color: var(--primary-color); font-size: 1rem; padding: 0.8rem; }
        .btn-reset-outline { 
            background: white; border: 1px solid #fee2e2; color: #ef4444; font-size: 1rem; padding: 0.8rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* QUIZ MODE UI */
        .mock-setup-container { padding: 1.5rem; flex: 1; overflow-y: auto; }
        .mock-title { font-size: 1.2rem; font-weight: 900; margin-bottom: 1rem; color: #1e293b; }
        .num-input-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .num-input { 
            width: 80px; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1.1rem; font-weight: 700; text-align: center; 
        }
        .tree-container { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .tree-header { padding: 0.8rem 1rem; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .tree-content { max-height: 400px; overflow-y: auto; }
        .tree-cat { border-bottom: 1px solid #f1f5f9; }
        .tree-cat-head { padding: 0.8rem 1rem; display: flex; align-items: center; gap: 0.5rem; background: white; cursor: pointer; }
        .tree-cat-head label { flex: 1; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
        .tree-items { display: none; padding-left: 2rem; border-top: 1px solid #f1f5f9; background: #f8fafc; }
        .tree-items.open { display: block; }
        .tree-item { padding: 0.6rem 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #f1f5f9; }
        .tree-item label { font-size: 0.9rem; color: #475569; cursor: pointer; }

        .result-card { background: white; border-radius: 16px; padding: 2rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        .result-score { font-size: 3.5rem; font-weight: 900; color: var(--primary-color); margin: 0.5rem 0; line-height: 1; }
        .result-msg { font-size: 1rem; font-weight: 700; color: #64748b; margin-bottom: 1.5rem; }
        .result-list { text-align: left; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 1rem; }
        .result-item { padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; gap: 0.8rem; align-items: center; cursor: pointer; }
        .result-item:active { background: #f8fafc; }
        .res-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 800; min-width: 30px; text-align: center; }
        .res-o { background: #dcfce7; color: #166534; }
        .res-x { background: #fee2e2; color: #b91c1c; }

        /* MODALS & TOAST */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: white; width: 100%; height: 85%;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;
            padding-bottom: env(safe-area-inset-bottom);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        #manager-preview-modal { z-index: 60; }
        #input-modal { z-index: 70; }
        
        /* ONBOARDING MODAL */
        #onboarding-modal { z-index: 999; align-items: center; justify-content: center; }
        #onboarding-modal .modal-content {
            width: 90%; height: auto; max-height: 80%;
            border-radius: 20px; padding: 0; overflow: hidden;
        }
        .onboarding-slider { flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .onboarding-slide { 
            flex: 0 0 100%; width: 100%; padding: 2rem 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            scroll-snap-align: center;
        }
        .slide-icon { margin-bottom: 1.5rem; }
        .slide-icon svg { width: 5rem; height: 5rem; }
        
        .slide-title { font-size: 1.3rem; font-weight: 900; color: #1e293b; margin-bottom: 1rem; line-height: 1.3; }
        .slide-desc { font-size: 0.95rem; color: #475569; line-height: 1.6; word-break: keep-all; }
        
        .warn-box {
            background: #fef2f2; border: 1px solid #fee2e2; border-radius: 12px; padding: 0.8rem;
            margin-top: 1rem; font-size: 0.85rem; color: #b91c1c; text-align: left; line-height: 1.4;
        }
        .tip-box {
            background: #fffbeb; border: 1px solid #fcd34d; border-radius: 12px; padding: 0.8rem;
            margin-top: 1rem; font-size: 0.85rem; color: #92400e; text-align: left; line-height: 1.4;
        }
        /* 닫기 버튼 (우측 상단 고정) */
        .onboarding-close {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem; color: #94a3b8;
            cursor: pointer; z-index: 10; padding: 0.5rem; line-height: 1;
        }
        .onboarding-nav { 
            padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; 
        }
        .dots { display: flex; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #e2e8f0; transition: 0.3s; }
        .dot.active { background: var(--primary-color); width: 20px; border-radius: 10px; }

        /* EDIT HELP OVERLAY */
        #edit-help-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 80; display: none; flex-direction: column;
            padding: 2rem; color: white;
        }
        .edit-help-arrow { font-size: 2rem; margin-bottom: 0.5rem; color: #fbbf24; }
        .edit-help-text { font-size: 1rem; font-weight: 600; line-height: 1.5; margin-bottom: 2rem; }

        .chip-container { display: flex; gap: 0.5rem; padding: 0 1rem; padding-top: 1rem; flex-wrap: wrap; }
        .field-chip { 
            padding: 6px 12px; border-radius: 20px; border: 1px solid #cbd5e1; background: white; 
            font-size: 0.85rem; font-weight: 700; color: #94a3b8; cursor: pointer; 
        }
        .field-chip.active { background: #eff6ff; color: var(--primary-color); border-color: var(--primary-color); }

        .toast-container {
            position: absolute; bottom: 6rem; left: 0; width: 100%;
            display: flex; justify-content: center; pointer-events: none; z-index: 100;
        }
        .toast {
            background: rgba(30, 41, 59, 0.9); color: white; padding: 0.8rem 1.5rem;
            border-radius: 99px; font-weight: 600; font-size: 0.9rem;
            opacity: 0; transform: translateY(10px); transition: 0.3s;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .editor-toolbar {
            display: flex; gap: 0.5rem; padding: 0.8rem 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; overflow-x: auto;
        }
        .tool-btn {
            padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; 
            font-weight: 700; font-size: 0.9rem; cursor: pointer; min-width: 36px;
        }
        .color-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #e2e8f0; cursor: pointer; }
        .color-btn.black { background: #1e293b; }
        .color-btn.red { background: #ef4444; }
        .color-btn.blue { background: #2563eb; }
        .rich-editor {
            width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px;
            font-size: 1rem; font-family: inherit; resize: none; min-height: 2.5rem;
            outline: none; line-height: 1.5; color: #334155;
        }
        .rich-editor:focus { border-color: var(--primary-color); background: #f8fafc; }
        .rich-editor.detail { flex: 1; overflow-y: auto; }
        .timer-option-btn {
            width: 100%; padding: 1rem; margin-bottom: 0.5rem;
            border: 1px solid #e2e8f0; border-radius: 12px;
            background: white; color: #1e293b; font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }

        /* --- 📱 모바일 전용 최적화 (텍스트 유지 & 줄바꿈 방지 버전) --- */
        @media (max-width: 768px) {
            html { font-size: 14px; }
            
            /* 1. 헤더 전체 공간 확보 */
            header { 
                height: calc(54px + env(safe-area-inset-top)); 
                padding: 0 0.5rem; /* 좌우 여백 최소화 */
                padding-top: env(safe-area-inset-top);
                gap: 0.3rem; /* 로고와 버튼 사이 간격 좁힘 */
            }
            
            /* 2. 왼쪽 브랜드 로고 다이어트 */
            .brand-box .main-title { font-size: 0.9rem; white-space: nowrap; } 
            .brand-box .sub-title { display: none; } /* 버전 정보(v1.2)는 공간 확보를 위해 숨김 */
            .timer-badge { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
            .timer-badge svg { width: 0.9rem; height: 0.9rem; } /* 시계 아이콘 축소 */

            /* 3. 오른쪽 버튼 컨트롤 영역 */
            .header-controls { gap: 0.2rem; } /* 버튼 사이 간격 좁힘 */

            /* 4. 리셋, 셔플 아이콘 버튼 크기 축소 */
            .icon-control-btn { 
                width: 28px; height: 28px; /* 크기 줄임 */
                padding: 0;
            }
            .icon-control-btn svg { width: 1rem; height: 1rem; }

            /* 5. 핵심: 학습/퀴즈/목록 버튼 최적화 */
            .header-btn {
                font-size: 0.75rem !important; /* 글자 크기 살짝 줄임 */
                padding: 0.4rem 0.5rem; /* 내부 여백 타이트하게 */
                gap: 0.2rem; /* 아이콘과 글자 사이 간격 좁힘 */
                white-space: nowrap; /* 🚨 절대 줄바꿈 하지 마라 (강제) */
                border-radius: 6px;
            }
            .header-btn svg {
                width: 0.9rem; height: 0.9rem; /* 버튼 내 아이콘 축소 */
            }

            /* 나머지 카드 및 하단 UI 최적화 */
            .card-front { padding: 1.2rem 0.8rem; gap: 0.6rem; }
            .info-box { padding: 0.7rem; gap: 0.2rem; }
            .info-content { font-size: 1.1rem; line-height: 1.4; }
            .vitals-container { gap: 0.2rem; }
            .vital-value { font-size: 1rem; }
            .vital-label { font-size: 0.7rem; }
            .controls { padding: 0.6rem; padding-bottom: calc(0.6rem + env(safe-area-inset-bottom)); }
            .btn { padding: 0.7rem; font-size: 1rem; border-radius: 10px; }
            .list-item { padding: 0.6rem 0.5rem; min-height: 48px; }
            .category-header { padding: 0.8rem; }
            }
            /* ✏️ 작성된 내용이 있을 때 연필 색상 변경 (파란색) */
            .icon-action-btn.filled { 
                background: #eff6ff; 
                color: #2563eb; 
                border-color: #bfdbfe; 
        }
/* 툴바 버튼 찌그러짐 방지 코드 (필수) */
        .editor-toolbar > * { flex-shrink: 0; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <div class="brand-box" onclick="switchMode('manager')" style="flex-direction:row; align-items:center; gap:0.6rem;">
                <img src="icon.PNG" style="width:2.2rem; height:2.2rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <span class="main-title">1분 CPX</span>
                    <span class="sub-title">v1.2</span>
                </div>
            </div>

            <div id="timer-badge" class="timer-badge" onclick="openTimerModal()">
                <svg style="width:1.2rem; height:1.2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span id="timer-text">60</span>
            </div>
        </div>
        <div class="header-controls">
            <button class="icon-control-btn" id="btn-reset" onclick="startSession('reset')" style="margin-right:0.3rem;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
            <button class="icon-control-btn" id="btn-shuffle" onclick="toggleShuffle()" style="margin-right:0.3rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
            </button>
            <button class="header-btn active" id="btn-mode-study" onclick="switchMode('study')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                학습
            </button>
            <button class="header-btn" id="btn-mode-mock" onclick="switchMode('mock-setup')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="15.5" r="1.5"></circle></svg>
                퀴즈
            </button>
            <button class="header-btn" id="btn-mode-list" onclick="switchMode('manager')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                목록
            </button>
        </div>
    </header>

    <div id="study-view" class="view-section active">
        <div class="progress-bar-area"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-float" id="progress-text">0 / 0</div>

        <div class="card-area">
            <div class="card-wrapper" id="card-wrapper">
                <div class="card-face card-front" id="card-front" onclick="flipCard(true)"></div>
                <div class="card-face card-back">
                    <div class="back-header">
                        <button class="nav-btn" onclick="flipCard(false)">문제 보기</button>
                        <div class="tool-btns">
                            <button class="icon-btn" onclick="hideCurrentCard()"><svg style="width:1.5rem; height:1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg></button>
                        </div>
                    </div>
                    <div class="cpx-form" id="card-back-form"></div>
                </div>
            </div>
            <div id="empty-state" style="display:none; text-align:center; color:#64748b; padding-top:2rem;">
                <svg style="width:3rem; height:3rem; margin-bottom:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 style="color:#1e293b; margin-bottom:0.5rem;">학습 종료</h3>
                <p>모든 카드를 확인했습니다.</p>
                <button class="btn" style="width:auto; display:inline-block; margin-top:1rem;" onclick="startSession('all')">처음부터 다시</button>
            </div>
        </div>

        <div class="controls">
            <div class="nav-row" id="front-nav">
                <button class="btn btn-nav" onclick="prevCard()">&lt;</button>
                <button class="btn btn-main" onclick="flipCard(true)">정답 확인</button>
                <button class="btn btn-nav" onclick="nextCard()">&gt;</button>
            </div>
            <div class="btn-group" id="answer-btns" style="display:none;">
                <button class="btn btn-red" onclick="handleAnswer(false)">← 몰랐어요</button>
                <button class="btn btn-green" onclick="handleAnswer(true)">알아요 →</button>
            </div>
            <div class="btn-group" id="review-nav" style="display:none;">
                <button class="btn" style="grid-column: span 2;" onclick="returnToResults()">🔙 결과 화면으로 돌아가기</button>
            </div>
        </div>
        <div class="toast-container"><div id="toast" class="toast">메시지</div></div>
    </div>

    <div id="mock-setup-view" class="view-section" style="background:#fff;">
        <div class="mock-setup-container">
            <div class="mock-title">퀴즈 설정</div>
            <div class="num-input-row">
                <span style="font-weight:700; font-size:1rem; color:#475569;">문제 수</span>
                <input type="number" id="mock-num" class="num-input" value="5" min="1" max="48">
                <span style="font-size:0.9rem; color:#94a3b8;">(단원별 1문제 우선 출제)</span>
            </div>
            
            <div class="tree-container">
                <div class="tree-header">
                    <span>출제 범위 선택</span>
                    <button class="btn" style="padding:0.3rem 0.8rem; font-size:0.8rem; width:auto; height:auto;" onclick="toggleAllMockTree()">전체 선택/해제</button>
                </div>
                <div class="tree-content" id="mock-tree-root"></div>
            </div>
        </div>
        <div class="controls">
            <button class="btn" onclick="startMockExam()">퀴즈 시작</button>
        </div>
    </div>

    <div id="mock-result-view" class="view-section" style="background:#f1f5f9; padding:1.5rem; overflow-y:auto;">
        <div class="result-card">
            <div style="font-size:1rem; font-weight:700; color:#64748b;">오늘의 결과</div>
            <div class="result-score" id="result-score-text">0 / 0</div>
            <div class="result-msg" id="result-msg">잘했어요!</div>
            <div id="retry-wrong-btn-area" style="display:none; margin-bottom:1rem;">
                <button class="btn btn-red" style="width:100%; padding:0.8rem;" onclick="retryWrongAnswers()">
                    ❌ 틀린 문제만 다시 하기
                </button>
            </div>
            <p style="color:#94a3b8; font-size:0.85rem;">문제를 터치하면 해당 카드로 이동합니다</p>
        </div>
        <div class="result-list" id="result-list"></div>
        <div style="margin-top:auto; padding-bottom:2rem;">
            <button class="btn" onclick="switchMode('mock-setup')">새로운 퀴즈 하기</button>
        </div>
    </div>

    <div id="manager-view" class="view-section">
        <div class="list-action-bar">
            <button class="btn" style="width:auto; padding:0.4rem 0.8rem; font-size:0.85rem;" onclick="showOnboarding(true)">
                💡 도움말
            </button>
            <button class="btn" style="width:auto; padding:0.4rem 0.8rem; font-size:0.85rem;" id="btn-toggle-all" onclick="toggleAllCards()">
                ☑️ 전체 선택/해제
            </button>
        </div>
        <div class="list-container" id="list-container"></div>      

        <div class="controls" style="background:white; display:block; padding:0; border-top:1px solid #e2e8f0;">
            <details style="width:100%;">
                <summary style="padding:1rem; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; font-weight:700; color:#475569; background:#f8fafc;">
                    <span>⚙️ 데이터 관리 / 백업 설정</span>
                    <span style="font-size:0.8rem; color:#94a3b8;">▼</span>
                </summary>
                
                <div style="padding:1rem; background:white; border-top:1px solid #f1f5f9;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; margin-bottom:1rem;">
                        <button class="btn btn-blue-outline" onclick="exportDataToClipboard()" style="font-size:0.9rem; padding:0.8rem;">
                            📤 복사 (내보내기)
                        </button>
                        <button class="btn btn-blue-outline" onclick="importDataFromClipboard()" style="font-size:0.9rem; padding:0.8rem;">
                            📥 붙여넣기 (가져오기)
                        </button>
                    </div>
                    
                    <details>
                        <summary style="cursor:pointer; color:#94a3b8; font-size:0.8rem; margin-bottom:0.5rem; text-align:right;">수동 입력창 열기 ▼</summary>
                        <textarea id="import-text-area" class="rich-editor" style="min-height:80px; font-size:0.8rem; width:100%;" placeholder="여기에 백업 코드를 붙여넣으세요."></textarea>
                        <button class="btn" style="margin-top:0.5rem; padding:0.6rem; font-size:0.9rem; width:100%;" onclick="importFromTextArea()">
                            텍스트로 복원하기
                        </button>
                    </details>

                    <div style="margin-top:1.5rem; border-top:1px solid #f1f5f9; padding-top:1rem;">
                        <button class="btn btn-reset-outline" style="width:100%; padding:0.8rem;" onclick="resetData()">
                            🗑️ 데이터 초기화
                        </button>
                    </div>
                </div>
            </details>
        </div>
    </div>
    
    <div class="modal-overlay" id="input-modal">
        <div class="modal-content">
            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700;">내용 편집</span>
                <button onclick="closeModal()" style="font-size:1.5rem; background:none; border:none;">&times;</button>
            </div>
            <div class="editor-toolbar">
		<button class="tool-btn" onmousedown="event.preventDefault(); setFontSize(3)" title="보통" style="font-size:0.9rem; padding:0; width:28px; height:28px;">가</button>
            	<button class="tool-btn" onmousedown="event.preventDefault(); setFontSize(5)" title="크게" style="font-size:1.1rem; font-weight:bold; padding:0; width:28px; height:28px;">가</button>
            <div style="width:1px; background:#cbd5e1; margin:0 5px;"></div>    
		<button class="tool-btn" onmousedown="event.preventDefault(); execCmd('bold')">B</button>
                <button class="tool-btn" onmousedown="event.preventDefault(); execCmd('italic')"><i>I</i></button>
                <button class="tool-btn" onmousedown="event.preventDefault(); execCmd('underline')"><u>U</u></button>

              <div style="width:1px; background:#cbd5e1; margin:0 5px;"></div>
                <button class="color-btn black" onmousedown="event.preventDefault(); execColor('#334155')"></button>
                <button class="color-btn red" onmousedown="event.preventDefault(); execColor('#ef4444')"></button>
                <button class="color-btn blue" onmousedown="event.preventDefault(); execColor('#2563eb')"></button>
             <div style="width:1px; background:#cbd5e1; margin:0 5px;"></div>
                
                <button class="hl-btn yellow" onmousedown="event.preventDefault(); toggleHighlight('yellow')" title="노란 형광펜"></button>
                <button class="hl-btn green" onmousedown="event.preventDefault(); toggleHighlight('green')" title="연두 형광펜"></button>
           	

            </div>
            <div style="padding:0 1.5rem 1.5rem; flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <div class="input-group">
                    <label style="font-size:0.85rem; font-weight:700; color:#64748b; display:block; margin-bottom:0.5rem;">🔑 키워드 / 암기법</label>
                    <div id="modal-editor-key" class="rich-editor" contenteditable="true" placeholder="내용을 입력하세요..."></div>
                </div>
                <div class="input-group" style="flex:1; display:flex; flex-direction:column; overflow:hidden; margin-top:1rem;">
                    <label style="font-size:0.85rem; font-weight:700; color:#64748b; display:block; margin-bottom:0.5rem;">📝 상세 해설</label>
                    <div id="modal-editor-val" class="rich-editor detail" contenteditable="true" placeholder="상세 해설을 입력하세요..."></div>
                </div>
            </div>
            <input type="hidden" id="modal-field-key">
            <div style="padding:1rem; border-top:1px solid #e2e8f0;">
                <button class="btn" onclick="saveFieldData()">저장 완료</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="manager-preview-modal">
        <div class="modal-content" style="position:relative;">
            <div id="edit-help-overlay" onclick="closeEditHelp()">
                <div style="margin-top:4rem; text-align:left;">
                    <div class="edit-help-arrow">⬆️</div>
                    <div class="edit-help-text">
                        카드 뒷면에 포함될 항목을<br>선택할 수 있습니다.
                    </div>
                    <div class="edit-help-arrow" style="margin-top:2rem;">⬇️</div>
                    <div class="edit-help-text">
                        각 항목을 눌러<br>나만의 암기법과 해설을<br>작성하세요.
                    </div>
                    <div style="margin-top:auto; text-align:center; color:#cbd5e1; font-weight:400; font-size:0.9rem;">
                        (화면을 터치하면 닫힙니다)
                    </div>
                </div>
            </div>

            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <span style="font-weight:700;" id="manager-preview-title">카드 편집</span>
                    <button class="icon-btn delete" style="width:28px; height:28px;" onclick="deleteCardData(editTargetId)">
                        <svg style="width:1.2rem; height:1.2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                <button onclick="document.getElementById('manager-preview-modal').classList.remove('open')" style="font-size:1.5rem; background:none; border:none;">&times;</button>
            </div>
            <div class="chip-container" id="preview-chips">
                <div class="field-chip active" onclick="toggleField(this, 'C')">C</div>
                <div class="field-chip active" onclick="toggleField(this, 'A')">A</div>
                <div class="field-chip active" onclick="toggleField(this, 'F')">F</div>
                <div class="field-chip active" onclick="toggleField(this, 'PEx')">PEx</div>
                <div class="field-chip active" onclick="toggleField(this, 'Edu')">Edu</div>
                <div class="field-chip active" onclick="toggleField(this, 'Memo')">Memo</div>
            </div>
            <div class="cpx-form" id="manager-preview-form" style="padding:1.5rem;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="timer-modal">
        <div class="modal-content" style="height:auto; min-height:30%;">
            <div style="padding:1rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700;">타이머 설정</span>
                <button onclick="closeTimerModal()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
            </div>
            <div style="padding:1.5rem;">
                <button class="timer-option-btn" onclick="setTimerOption('1min')">1분 연습 <span style="font-weight:400; color:#64748b;">60초</span></button>
                <button class="timer-option-btn" onclick="setTimerOption('unlimited')">무제한 <span style="font-weight:400; color:#64748b;">&infin;</span></button>
                <button class="timer-option-btn" onclick="setTimerOption('custom')">직접 입력</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="onboarding-modal">
        <div class="modal-content" style="background:white; position:relative;">
            <button class="onboarding-close" onclick="closeOnboarding()">&times;</button>
            
            <div class="onboarding-slider" id="onboard-slider"></div>
            
            <div class="onboarding-nav">
                <div class="dots" id="onboard-dots"></div> <button class="btn" style="width:auto; padding:0.8rem 1.5rem;" id="onboard-next-btn" onclick="nextSlide()">다음</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- DATA & LOGIC ---

// 1. 도움말 데이터 (새로 추가한 것)
const ONBOARDING_DATA = [
    {
        type: 'image', src: 'icon.PNG', color: '',
        title: '시간과 장소를<br>가리지 않는 1분 훈련',
        desc: `짧은 시간 안에 주소(C.C)를 보고<br><b>Associated Sx</b>부터 <b>PEx</b>까지<br>1분 안에 떠올리는 연습을 위해 만들어졌습니다.<br><br><span style="font-size: 0.8rem; color: #94a3b8;">Created by <b>KNU FM JSW</b></span>`,
        extra: `<div class="warn-box">⚠️ <b>주의:</b> 아직 본격적인 <b>실기 대비 1회차를 시작하지 않았다면</b> 큰 도움이 되지 않을 수 있습니다.</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>`,
        title: '오늘의 공부를 복습하세요',
        desc: `학습모드에서 제한 시간과 순서를 설정해 무작위 증례를 학습합니다.<br>카드 뒷면에서 바로 내용을 수정할 수 있습니다.`,
        extra: `<div class="tip-box">💡 <b>Tip:</b> 1회차 연습을 돌면서,<br><b>그날 진행했던 주제를 복습</b>하는 용도로 추천합니다.</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="15.5" r="1.5"></circle>`,
        title: '실전 감각 키우기',
        desc: `퀴즈모드에서 원하는 계통과 문제 수를 설정해 무작위로 테스트합니다.`,
        extra: `<div class="tip-box">💡 <b>Tip:</b> 전체 회독이 끝난<br><b>2회차 이후부터</b>, 전 범위를 선택해 실력을 유지하세요.</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>`,
        title: '나만의 암기법 완성',
        desc: `한끝, 유니온, 알렌... 다양한 암기법 중<br>목록에서 <b>연필 아이콘(✏️)</b>을 눌러<br>내 입에 맞는 키워드를 적어두세요.<br>카메라 버튼을 눌러 편하게 입력도 가능합니다!`,
        extra: `<div class="tip-box">💡 <b>Tip:</b> 지금 바로 목록으로 가서,<br><b>오늘 공부한 주제부터</b> 정리를 시작해보세요!</div>`
    },
    {
        type: 'svg', color: '#2563eb',
        path: `<rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><path d="M12 14v-4m0 0l-2 2m2-2l2 2" stroke="#2563eb"></path>`,
        title: '앱처럼 설치하세요',
        desc: `매번 주소를 입력할 필요 없이<br><b>'홈 화면에 추가'</b>를 해보세요.<br>진짜 어플처럼 아이콘이 생깁니다!`,
        extra: `<div class="tip-box" style="text-align:left; font-size:0.85rem;">🍎 <b>iOS(Safari):</b><br>하단 공유 버튼(네모+화살표) → <b>'홈 화면에 추가'</b><br><br>🤖 <b>Android(Chrome):</b><br>상단 메뉴(점 3개) → <b>'홈 화면에 추가'</b> (또는 앱 설치)</div>`
    },
    {
        type: 'svg', color: '#ef4444',
        path: `<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>`,
        title: '데이터 백업 & 주의사항',
        desc: `목록 탭 하단의 <b>[내보내기/가져오기]</b>를 통해<br>아이폰↔아이패드↔PC 간 데이터를<br>자유롭게 이동할 수 있습니다.`,
        extra: `<div class="warn-box" style="text-align:center; font-size:0.9rem;">🚨 <b>매우 중요!</b><br>이 앱은 서버가 없습니다.<br><b>'인터넷 사용 기록(캐시) 삭제'</b>를 하면<br>작성한 내용이 모두 사라집니다.<br><b>꼭! 수시로 백업 코드를 복사해두세요.</b></div>`
    }
];

// 2. 주제 데이터 (원래 있던 것)
const TOPICS = [
    {id:1, cat:"소화기", title:"01. 급성 복통"}, {id:2, cat:"소화기", title:"02. 소화불량/만성 복통"}, {id:3, cat:"소화기", title:"03. 토혈"},
    {id:4, cat:"소화기", title:"04. 혈변"}, {id:5, cat:"소화기", title:"05. 구토"}, {id:6, cat:"소화기", title:"06-1. 배변 이상(변비)"},
    {id:57, cat:"소화기", title:"06-2. 배변 이상(설사)"}, {id:7, cat:"소화기", title:"07. 황달"}, {id:8, cat:"순환기", title:"08. 가슴 통증"},
    {id:9, cat:"순환기", title:"09. 실신"}, {id:10, cat:"순환기", title:"10. 두근거림"}, {id:11, cat:"순환기", title:"11. 고혈압"},
    {id:12, cat:"순환기", title:"12. 이상지질혈증"}, {id:13, cat:"호흡기", title:"13. 기침"}, {id:14, cat:"호흡기", title:"14. 콧물/코막힘"},
    {id:15, cat:"호흡기", title:"15. 객혈"}, {id:16, cat:"호흡기", title:"16. 호흡곤란"}, {id:17, cat:"신장/비뇨", title:"17-1. 소변량 변화(다뇨증)"},
    {id:58, cat:"신장/비뇨", title:"17-2. 소변량 변화(핍뇨)"}, {id:18, cat:"신장/비뇨", title:"18. 붉은색 소변"}, {id:19, cat:"신장/비뇨", title:"19-1. 배뇨 이상"},
    {id:59, cat:"신장/비뇨", title:"19-2. 소변찔끔증"}, {id:20, cat:"전신", title:"20. 발열"}, {id:21, cat:"전신", title:"21. 쉽게 멍이 듦"},
    {id:22, cat:"전신", title:"22. 피로"}, {id:23, cat:"전신", title:"23. 체중 감소"}, {id:24, cat:"전신", title:"24. 체중 증가/비만"},
    {id:25, cat:"관절/근골격/피부", title:"25. 관절 통증/부기"}, {id:26, cat:"관절/근골격/피부", title:"26-1. 목 통증"}, {id:60, cat:"관절/근골격/피부", title:"26-2. 허리 통증"},
    {id:27, cat:"관절/근골격/피부", title:"27. 피부 발진"}, {id:28, cat:"정신/신경", title:"28. 기분 변화"}, {id:29, cat:"정신/신경", title:"29. 불안"},
    {id:30, cat:"정신/신경", title:"30. 수면장애"}, {id:31, cat:"정신/신경", title:"31. 기억력 저하"}, {id:32, cat:"정신/신경", title:"32. 어지럼"},
    {id:33, cat:"정신/신경", title:"33. 두통"}, {id:34, cat:"정신/신경", title:"34. 경련"}, {id:35, cat:"정신/신경", title:"35. 근력/감각 이상"},
    {id:36, cat:"정신/신경", title:"36. 의식장애"}, {id:37, cat:"정신/신경", title:"37. 떨림/운동 이상"}, {id:38, cat:"산부/여성/소아", title:"38. 유방통/유방덩이"},
    {id:39, cat:"산부/여성/소아", title:"39-1. 질분비물"}, {id:61, cat:"산부/여성/소아", title:"39-2. 질출혈"}, {id:40, cat:"산부/여성/소아", title:"40-1. 월경 이상"},
    {id:62, cat:"산부/여성/소아", title:"40-2. 월경통"}, {id:41, cat:"산부/여성/소아", title:"41. 산전 진찰"}, {id:42, cat:"산부/여성/소아", title:"42-1. 성장 지연"},
    {id:63, cat:"산부/여성/소아", title:"42-2. 발달 지연"}, {id:43, cat:"산부/여성/소아", title:"43. 예방접종"}, {id:44, cat:"상담", title:"44-1. 음주 상담"},
    {id:64, cat:"상담", title:"44-2. 금연 상담"}, {id:45, cat:"상담", title:"45. 물질 오남용"}, {id:46, cat:"상담", title:"46. 나쁜 소식 전하기"},
    {id:47, cat:"상담", title:"47-1. 가정 폭력"}, {id:65, cat:"상담", title:"47-2. 성 폭력"}, {id:48, cat:"상담", title:"48. 자살"}
];

const NAMES_L = ['김','이','박','최','정','강','조','윤','장','임'];
const NAMES_M = ['철수','민수','영호','준호','상철','성호','동현','재우'];
const NAMES_F = ['영희','미영','지은','수진','혜진','정숙','민지','현주'];
const ALL_FIELDS = ['C','A','F','PEx','Edu','Memo'];

function getRandomInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
function getRandomItem(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
function getNormalVitals() {
    return {
        bp: `${getRandomInt(100,135)}/${getRandomInt(60,85)}`,
        hr: `${getRandomInt(60,95)}회`,
        rr: `${getRandomInt(14,20)}회`,
        bt: `36.${getRandomInt(3,7)}℃`
    };
}

const HYBRID_SKILLS = {
    3: ["혈압 측정을 시행하시오.", "정맥 주사를 시행하시오.", "안전수혈술기를 시행하시오."],
    4: ["항문 직장 진찰을 시행하시오.", "혈압 측정을 시행하시오.", "정맥 주사를 시행하시오.", "안전수혈술기를 시행하시오."],
    5: ["정맥 주사를 시행하시오."], 6: ["항문 직장 진찰을 시행하시오."], 57: ["정맥 주사를 시행하시오."],
    7: ["동맥혈 채혈을 시행하시오."], 9: ["혈압 측정을 시행하시오."], 11: ["혈압 측정을 시행하시오."],
    13: ["동맥혈 채혈을 시행하시오."], 15: ["안전수혈술기를 시행하시오."], 20: ["혈액 배양을 위한 채혈을 시행하시오."],
    21: ["안전수혈술기를 시행하시오."], 32: ["이경 검사를 시행하시오.", "혈압 측정을 시행하시오.", "안저 검사를 시행하시오."],
    62: ["자궁경부 펴바름 검사를 시행하시오.", "질 분비물 검사를 시행하시오."], 40: ["자궁경부 펴바름 검사를 시행하시오.", "질 분비물 검사를 시행하시오."],
    41: ["분만 진행 단계 진찰을 시행하시오.", "자궁경부 펴바름 검사를 시행하시오.", "질 분비물 검사를 시행하시오."], 65: ["질 분비물 검사를 시행하시오."]
};

// 증례 생성기 (소아과 표현 개선 버전)
// 증례 생성기 ("환아" 표현 삭제 버전)
function generateCase(card) {
    let title = card.title;
    let isMale = Math.random() > 0.5;
    let age = getRandomInt(20, 75);
    let name = getRandomItem(NAMES_L) + (isMale ? getRandomItem(NAMES_M) : getRandomItem(NAMES_F));
    let scenario = "";
    let vitals = getNormalVitals();
    let instructions = ["증상과 관련된 병력을 청취하고,", "적절한 신체진찰을 시행한 후,", "추정진단과 향후 계획을 환자와 논의하시오."];
    
    // 소아 여부 플래그
    let isChild = false; 

    switch(card.id) {
        case 1: scenario = "배가 아파 내원하였다."; break;
        case 2: scenario = getRandomItem(["배가 아프다고 내원하였다.", "소화가 되지 않아 내원하였다."]); break;
        case 3: scenario = "피를 토해 내원하였다." + (Math.random()>0.7?" (현재 응급실, 아침 9시)":""); if(scenario.includes("응급실")) { vitals.hr = "110회"; vitals.bp = "90/60"; } break;
        case 4: scenario = getRandomItem(["혈변을 본다며 내원하였다.", "변에서 피가 나왔다며 내원하였다." + (Math.random()>0.7?" (현재 응급실)":"")]); break;
        case 5: scenario = Math.random()>0.5 ? "구토를 했다고 내원하였다." : "구토를 심하게 해서 응급실로 내원하였다."; break;
        case 6: isMale=false; scenario = "변비가 있다고 내원하였다."; break;
        case 57: scenario = "설사를 한다고 내원하였다."; break;
        case 7: scenario = "눈이 노래졌다고 내원하였다."; break;
        case 8: scenario = "가슴이 아프다고 내원하였다."; break;
        case 9: scenario = getRandomItem(["의식을 잃었다며 내원하였다.", "쓰러졌다며 내원하였다.", "기절했다며 내원하였다.", "실신을 했다고 내원하였다."]); break;
        case 10: scenario = getRandomItem(["가슴이 두근거린다고 내원하였다.", "두근거리는 증상으로 내원하였다."]); break;
        case 11: age=62; scenario = "혈압이 높다고 내원하였다."; vitals.bp = "150/95"; break;
        case 12: scenario = getRandomItem(["콜레스테롤 수치가 높아 내원하였다.", "지방 수치가 높다고 내원하였다."]); break;
        case 13: scenario = "기침을 한다고 내원하였다."; break;
        case 14: scenario = "콧물이 난다고 내원하였다."; break;
        case 15: scenario = "목에서 피가 난다고 내원하였다."; break;
        case 16: scenario = Math.random()>0.5 ? "숨이 찬다고 내원하였다." : "숨이 차서 응급실로 내원하였다."; if(scenario.includes("응급실")) vitals.rr = "28회"; break;
        case 17: scenario = "소변량이 많아졌다고 내원하였다."; break;
        case 58: scenario = "소변량이 줄어들었다고 내원하였다."; break;
        case 18: scenario = "소변색이 붉다고 내원하였다."; break;
        case 19: scenario = getRandomItem(["소변을 볼 때 아프다고 내원하였다.", "소변 보는 게 불편해 내원하였다.", "소변을 자주 봐서 내원하였다."]); break;
        case 59: scenario = "소변이 샌다고 내원하였다."; break;
        case 20: scenario = "열이 난다고 내원하였다."; vitals.bt = "38.2℃"; vitals.hr = "105회"; break;
        case 21: scenario = getRandomItem(["다리에 뭐가 생긴다고 내원하였다.", "피부에 반점이 생겨 내원하였다.", "멍이 잘 들어 내원하였다."]); break;
        case 22: scenario = "피곤해서 내원하였다."; break;
        case 23: scenario = "살이 빠진다고 내원하였다."; break;
        case 24: scenario = "살이 찐다고 내원하였다."; break;
        case 25: scenario = getRandomItem(["손이 아프다고 내원하였다.", "발가락이 아프다고 내원하였다.", "어깨가 아프다고 내원하였다.", "무릎이 아프다고 내원하였다."]); break;
        case 26: scenario = "목이 아프다고 내원하였다."; break;
        case 60: scenario = "허리가 아프다고 내원하였다."; break;
        case 27: scenario = getRandomItem(["피부에 뭐가 났다고 내원하였다.", "피부 발진으로 내원하였다."]); break;
        case 28: scenario = "우울하다고 내원하였다."; break;
        case 29: scenario = "불안하다고 내원하였다."; break;
        case 30: scenario = "잠을 못 자겠다고 내원하였다."; break;
        case 31: age=getRandomInt(65,80); scenario = "기억력이 떨어졌다고 내원하였다."; break;
        case 32: scenario = "어지럽다고 내원하였다."; break;
        case 33: scenario = "머리가 아프다고 내원하였다."; break;
        case 34: if(Math.random()>0.5) { isChild=true; age="12개월"; isMale=true; name="박로하"; scenario="경련을 한다며 보호자와 함께 응급실로 내원하였다."; } else { scenario = "경련을 했다고 내원하였다."; } break;
        case 35: scenario = getRandomItem(["팔다리에 힘이 빠진다고 내원하였다.", "팔에 힘이 빠진다고 내원하였다."]); break;
        case 36: scenario = getRandomItem(["쓰러졌다며 응급실로 내원하였다.", "의식이 떨어져 보호자와 함께 응급실로 내원하였다."]); break;
        case 37: scenario = "손이 떨린다고 내원하였다."; break;
        case 38: isMale=false; scenario = getRandomItem(["유방 통증을 호소하며 내원하였다.", "유방에서 덩이가 만져져 내원하였다."]); break;
        case 39: isMale=false; scenario = getRandomItem(["냉이 많아져 내원하였다.", "질분비물이 있다고 내원하였다."]); break;
        case 61: isMale=false; scenario = "질출혈이 있어서 내원하였다."; break;
        case 40: isMale=false; scenario = getRandomItem(["월경을 안 해서 내원하였다.", "월경량이 많아졌다고 내원하였다."]); break;
        case 62: isMale=false; age=20; scenario = "월경통이 있다고 내원하였다."; break;
        case 41: isMale=false; age=getRandomInt(28,35); scenario = getRandomItem(["산전진찰을 위해 내원하였다.", "구토 때문에 내원하였다.", "질 출혈 때문에 내원하였다.", "복통 때문에 내원하였다."]); break;
        
        // --- 👶 소아과 파트 (수정됨) ---
        case 42: // 성장 지연
            isChild = true; 
            isMale = false; 
            age = 5; 
            name = "김민지"; 
            scenario = "키가 작다며 보호자와 함께 내원하였다."; 
            instructions = ["성장과 관련된 병력을 청취하고,", "성장곡선을 참고하여 추정진단과 향후 계획을 논의하시오."]; 
            break;
            
        case 63: // 발달 지연
            isChild = true; 
            isMale = true; 
            age = "30개월"; 
            name = "이영우"; 
            scenario = "아이 발달이 느린 것 같다며 보호자와 함께 내원하였다."; 
            instructions = ["발달과 관련된 병력을 청취하고,", "성장곡선을 참고하여 추정진단과 향후 계획을 논의하시오."]; 
            break;
            
        case 43: // 예방접종
            isChild = true; 
            isMale = false;
            let baby = getRandomItem([{a:"7개월", n:"김민주"}, {a:"18개월", n:"윤서희"}]);
            age = baby.a; 
            name = baby.n; 
            scenario = "예방접종 상담을 위해 보호자와 함께 내원하였다."; 
            instructions = ["예방 접종 수첩을 확인하고, 필요한 병력을 청취하고,", "환자에게 필요한 예방접종을 상담하고,", "예방 수첩에 금일 접종 항목에 날짜와 병원을 기입하시오."]; 
            break;
            
        case 44: scenario = "술을 끊고 싶다며 내원하였다."; break;
        case 64: scenario = "담배를 끊고 싶다며 내원하였다."; break;
        case 45: scenario = "먹던 약을 처방받기 위해 내원하였다."; break;
        case 46: scenario = "두 달 전부터 소화불량이 있어 위내시경 및 CT를 시행하였으며, 결과 확인차 내원하였다."; break;
        case 47: isMale=false; scenario = getRandomItem(["멍이 들었다고 내원하였다.", "전신이 아프고 우울하여 내원하였다."]); break;
        case 65: isMale=false; age=22; scenario = "성 폭력을 당했다며 내원하였다."; break;
        case 48: scenario = getRandomItem(["죽고 싶다는 생각이 든다며 내원하였다.", "자살을 시도해서 내원하였다."]); break;
    }

    // --- 문장 조립 로직 ("환아" 삭제 버전) ---
    let subject = "";
    
    if (isChild) {
        // 소아: 나이(개월/살) + 성별(남아/여아) + 이름 + 가 ("환아" 삭제)
        let ageStr = (typeof age === 'number') ? age + "세" : age; 
        let genderStr = isMale ? "남아" : "여아";
        // 변경: "환아가" -> "가"
        subject = `${ageStr} ${genderStr} ${name}가`;
    } else {
        // 성인: 나이(세) + 성별(남자/여자) + 이름 + 씨가
        subject = `${age}세 ${isMale?'남자':'여자'} ${name}씨가`;
    }

    let caseData = { 
        title: card.title, 
        scenario: `${subject} ${scenario}`, 
        vitalsData: vitals, 
        instructions: instructions 
    };
    
    if (HYBRID_SKILLS[card.id]) { 
        caseData.instructions.splice(2, 0, `<span class="hybrid-skill">${getRandomItem(HYBRID_SKILLS[card.id])}</span>`); 
    }
    
    return caseData;
}

// GLOBAL
let cards = [], userData = {}, studyDeck = [], mockResults = [], currentIndex = 0, timerTime = 60, timeLeft = 60, timerInterval = null, isInfinite = false, collapsedCategories = {}, isShuffle = false, editTargetId = null, currentMode = 'study', currentSlide = 0;

function init() {
    console.log("%c 1분 CPX v1.2 \n%c OCR Enabled ", "color: white; background: #2563eb; padding: 5px; border-radius: 4px;", "color: #2563eb; background: white; padding: 5px;");
    const savedCards = localStorage.getItem('cpx_v37_cards');
    if(savedCards) cards = JSON.parse(savedCards); else { cards = TOPICS.map(t => ({...t, isVisible: true})); saveCards(); }
    const savedUser = localStorage.getItem('cpx_v37_userdata'); if(savedUser) userData = JSON.parse(savedUser);
    const savedCats = localStorage.getItem('cpx_v37_cats'); if(savedCats) collapsedCategories = JSON.parse(savedCats);
    const savedShuffle = localStorage.getItem('cpx_v38_shuffle'); isShuffle = savedShuffle !== null ? JSON.parse(savedShuffle) : false;
    
    updateShuffleUI();
    startSession('init_silent');
    switchMode('manager');

    // ONBOARDING
    const introSeen = localStorage.getItem('cpx_v5_onboarding_seen');
    if(!introSeen) showOnboarding(false);

    document.getElementById('onboard-slider').addEventListener('scroll', function() {
        const index = Math.round(this.scrollLeft / this.offsetWidth);
        if(currentSlide !== index) { currentSlide = index; setTimeout(updateDotsOnly, 100); }
    });

    document.addEventListener('keydown', (e) => {
        if(document.getElementById('input-modal').classList.contains('open')) return;
        if(document.getElementById('study-view').classList.contains('active')) {
            const wrapper = document.getElementById('card-wrapper');
            const isBack = wrapper.classList.contains('flipped');
            if(currentMode === 'review') {
                if(e.key === "ArrowLeft" || e.key === "Escape") returnToResults();
                else if(e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(!isBack);
                return;
            }
            if(isBack) {
                if(e.key === "ArrowLeft") handleAnswer(false);
                else if(e.key === "ArrowRight") handleAnswer(true);
                else if(e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(false);
            } else {
                if (e.key === "ArrowLeft") prevCard();
                else if (e.key === "ArrowRight") nextCard();
                else if (e.key === "ArrowUp" || e.key === "ArrowDown") flipCard(true);
            }
        }
    });
}

function saveCards() { localStorage.setItem('cpx_v37_cards', JSON.stringify(cards)); }
function saveUserData() { localStorage.setItem('cpx_v37_userdata', JSON.stringify(userData)); }
function saveCats() { localStorage.setItem('cpx_v37_cats', JSON.stringify(collapsedCategories)); }

// ONBOARDING
function renderOnboarding() {
    const slider = document.getElementById('onboard-slider');
    const dotsContainer = document.getElementById('onboard-dots');
    
    // 이미 렌더링 되어있으면 리셋
    slider.innerHTML = '';
    dotsContainer.innerHTML = '';

    ONBOARDING_DATA.forEach((slide, index) => {
        // 1. 슬라이드 생성
        const div = document.createElement('div');
        div.className = 'onboarding-slide';
        
        let iconHtml = '';
        if(slide.type === 'image') {
            iconHtml = `<img src="${slide.src}" style="width:6rem; height:6rem; border-radius:1.2rem; box-shadow:0 8px 16px -4px rgba(0,0,0,0.15);">`;
        } else {
            iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="${slide.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:5rem; height:5rem;">${slide.path}</svg>`;
        }

        div.innerHTML = `
            <div class="slide-icon">${iconHtml}</div>
            <div class="slide-title">${slide.title}</div>
            <div class="slide-desc">
                ${slide.desc}
                ${slide.extra ? slide.extra : ''}
            </div>
        `;
        slider.appendChild(div);

        // 2. 점(Dot) 생성
        const dot = document.createElement('div');
        dot.className = 'dot';
        dotsContainer.appendChild(dot);
    });
}

function showOnboarding(force) {
    if(force || !localStorage.getItem('cpx_v5_onboarding_seen')) {
        renderOnboarding(); // 데이터 기반으로 화면 그리기
        currentSlide = 0;
        const slider = document.getElementById('onboard-slider');
        slider.scrollLeft = 0;
        updateDotsOnly();
        document.getElementById('onboarding-modal').classList.add('open');
    }
}

function closeOnboarding() {
    localStorage.setItem('cpx_v5_onboarding_seen', 'true');
    document.getElementById('onboarding-modal').classList.remove('open');
}

function nextSlide() {
    if(currentSlide < ONBOARDING_DATA.length - 1) {
        currentSlide++;
        const slider = document.getElementById('onboard-slider');
        slider.scrollTo({left: slider.offsetWidth * currentSlide, behavior: 'smooth'});
        setTimeout(updateDotsOnly, 300);
    } else {
        closeOnboarding();
    }
}

function updateDotsOnly() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
    
    const btn = document.getElementById('onboard-next-btn');
    // 데이터 개수를 기반으로 마지막 페이지 판단
    if (currentSlide === ONBOARDING_DATA.length - 1) {
        btn.innerText = "1분 CPX 시작하기";
    } else {
        btn.innerText = "다음";
    }
}

// EDIT HELP
function checkEditHelp() {
    if(!localStorage.getItem('cpx_edit_help_seen')) { document.getElementById('edit-help-overlay').style.display = 'flex'; }
}
function closeEditHelp() { document.getElementById('edit-help-overlay').style.display = 'none'; localStorage.setItem('cpx_edit_help_seen', 'true'); }

// REST OF LOGIC
function toggleShuffle() {
    isShuffle = !isShuffle; localStorage.setItem('cpx_v38_shuffle', JSON.stringify(isShuffle)); updateShuffleUI();
    if(studyDeck.length > 0 && currentMode === 'study') {
        const played = studyDeck.slice(0, currentIndex); const current = studyDeck[currentIndex]; let remaining = studyDeck.slice(currentIndex + 1);
        if(isShuffle) { for (let i = remaining.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [remaining[i], remaining[j]] = [remaining[j], remaining[i]]; } showToast("🔀 남은 카드가 섞였습니다"); } 
        else { remaining.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); showToast("🔢 남은 카드가 정렬됩니다"); }
        studyDeck = [...played, current, ...remaining];
    }
}
function updateShuffleUI() { document.getElementById('btn-shuffle').classList.toggle('active', isShuffle); }
function startSession(mode) {
    if(mode === 'reset' && !confirm("현재 진행상황을 초기화하고 처음으로 되돌리겠습니까?")) return;
    currentMode = 'study'; let tempDeck = cards.filter(c => c.isVisible);
    if(isShuffle) { for (let i = tempDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [tempDeck[i], tempDeck[j]] = [tempDeck[j], tempDeck[i]]; } } 
    else { tempDeck.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); }
    studyDeck = tempDeck; currentIndex = 0;
    if(mode !== 'init_silent') { switchMode('study'); renderCard(); if(mode === 'reset') showToast("학습이 초기화되었습니다."); }
}
function renderCard() {
    const wrapper = document.getElementById('card-wrapper'); const emptyState = document.getElementById('empty-state');
    const navRow = document.getElementById('front-nav'); const ansBtns = document.getElementById('answer-btns'); const reviewNav = document.getElementById('review-nav');
    wrapper.classList.remove('shaking');
    if(studyDeck.length === 0 || currentIndex >= studyDeck.length) {
        if(currentMode === 'mock') { showMockResult(); } else { wrapper.style.display = 'none'; document.querySelector('.controls').style.display = 'none'; emptyState.style.display = 'block'; stopTimer(); } return;
    }
    wrapper.style.display = 'block'; document.querySelector('.controls').style.display = 'block'; emptyState.style.display = 'none'; wrapper.classList.remove('flipped');
    navRow.style.display = 'none'; ansBtns.style.display = 'none'; reviewNav.style.display = 'none';
    if(currentMode === 'review') reviewNav.style.display = 'grid'; else navRow.style.display = 'flex';
    const card = studyDeck[currentIndex]; const data = generateCase(card); const frontEl = document.getElementById('card-front');
    frontEl.innerHTML = `<div class="topic-badge">${data.title}</div><div class="info-box"><div class="info-label">상황 지침</div><div class="info-content">${data.scenario}</div></div><div class="info-box"><div class="vitals-container"><div class="vital-item"><span class="vital-label">혈압</span><span class="vital-value">${data.vitalsData.bp}</span></div><div class="vital-item"><span class="vital-label">맥박</span><span class="vital-value">${data.vitalsData.hr}</span></div><div class="vital-item"><span class="vital-label">호흡</span><span class="vital-value">${data.vitalsData.rr}</span></div><div class="vital-item"><span class="vital-label">체온</span><span class="vital-value">${data.vitalsData.bt}</span></div></div></div><div class="info-box"><div class="info-label">지시사항 : 응시자는 이 환자에게</div><ul class="instruction-list">${data.instructions.map(i => `<li>${i}</li>`).join('')}</ul></div><div class="touch-hint"><span class="pc-hint">⌨️ 위/아래 키 or </span>👆 터치하여 정답 확인</div>`;
    renderBack(card, 'card-back-form');
    document.getElementById('progress-text').innerText = `${currentIndex+1} / ${studyDeck.length}`; document.getElementById('progress-fill').style.width = `${((currentIndex)/studyDeck.length)*100}%`;
    stopTimer(); if(!isInfinite) { timeLeft = timerTime; startTimer(); } else updateTimerUI();
}
function renderBack(card, targetId) {
    const container = document.getElementById(targetId); const uData = userData[card.id] || {}; const activeFields = uData.activeFields || ALL_FIELDS; let formHtml = '';
    activeFields.forEach(code => {
        const key = uData[code+'_k'] || ''; const val = uData[code+'_v'] || '';
        formHtml += `<div class="field-group"><div class="field-header" onclick="toggleExpl(this)"><div class="field-label">${code}</div><div class="field-key ${!key ? 'empty' : ''}">${key || '(내용을 입력하세요...)'}</div></div><div class="explanation-box" onclick="openModal('${code}')">${val || '<span style="color:#cbd5e1">(해설을 입력하려면 여기를 누르세요)</span>'}</div></div>`;
    });
    if(activeFields.length === 0) formHtml = '<div style="padding:1rem; color:#94a3b8; text-align:center;">선택된 양식이 없습니다.<br>편집에서 칩을 선택해주세요.</div>';
    container.innerHTML = formHtml;
}
function flipCard(isBack) {
    const wrapper = document.getElementById('card-wrapper'); const frontNav = document.getElementById('front-nav'); const ansBtns = document.getElementById('answer-btns');
    if(isBack) { wrapper.classList.add('flipped'); stopTimer(); wrapper.classList.remove('shaking'); if(currentMode !== 'review') { frontNav.style.display = 'none'; ansBtns.style.display = 'grid'; } } 
    else { wrapper.classList.remove('flipped'); startTimer(); if(currentMode !== 'review') { frontNav.style.display = 'flex'; ansBtns.style.display = 'none'; } }
}
function handleAnswer(isCorrect) {
    const cId = studyDeck[currentIndex].id; if(!userData[cId]) userData[cId] = {};
    if(isCorrect) userData[cId].o = (userData[cId].o || 0) + 1; else userData[cId].x = (userData[cId].x || 0) + 1;
    saveUserData(); if(currentMode === 'mock') mockResults.push({ id: cId, result: isCorrect });
    currentIndex++; renderCard();
}
function prevCard() { if(currentIndex>0) { currentIndex--; renderCard(); } else showToast("첫 번째 카드입니다."); }
function nextCard() { if(currentIndex<studyDeck.length-1) { currentIndex++; renderCard(); } else showToast("마지막 카드입니다."); }
function hideCurrentCard() {
    const card = studyDeck[currentIndex]; const realIdx = cards.findIndex(c => c.id === card.id);
    if(realIdx > -1) { cards[realIdx].isVisible = false; saveCards(); studyDeck.splice(currentIndex, 1); showToast("숨겨졌습니다."); if(currentIndex >= studyDeck.length) currentIndex = Math.max(0, studyDeck.length - 1); renderCard(); }
}
function deleteCardData(id) {
    if(!confirm("이 카드에 작성한 내용이 모두 삭제됩니다. 초기화하시겠습니까?")) return;
    delete userData[id]; saveUserData(); renderBack(cards.find(c => c.id === id), 'manager-preview-form'); showToast("초기화되었습니다.");
}
function toggleExpl(el) { el.nextElementSibling.classList.toggle('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1500); }
function switchMode(mode) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.header-btn').forEach(el => el.classList.remove('active'));
    const btnReset = document.getElementById('btn-reset'); const btnShuffle = document.getElementById('btn-shuffle');
    if(mode === 'study') { document.getElementById('study-view').classList.add('active'); document.getElementById('btn-mode-study').classList.add('active'); btnReset.style.display = 'flex'; btnShuffle.style.display = 'flex'; if(studyDeck.length > 0) renderCard(); }
    else if (mode === 'manager') { document.getElementById('manager-view').classList.add('active'); document.getElementById('btn-mode-list').classList.add('active'); btnReset.style.display = 'none'; btnShuffle.style.display = 'none'; stopTimer(); renderManager(); }
    else if (mode.startsWith('mock')) { document.getElementById('btn-mode-mock').classList.add('active'); btnReset.style.display = 'none'; btnShuffle.style.display = 'none';
        if(mode === 'mock-setup') { document.getElementById('mock-setup-view').classList.add('active'); renderMockTree(); } else if(mode === 'mock-result') { document.getElementById('mock-result-view').classList.add('active'); } stopTimer();
    }
}
/* ▼▼▼ 파란 연필 기능이 복구된 목록 렌더링 함수 ▼▼▼ */
function renderManager() {
    const list = document.getElementById('list-container'); 
    list.innerHTML = ''; 
    const groups = {}; 
    cards.forEach(c => { if(!groups[c.cat]) groups[c.cat] = []; groups[c.cat].push(c); });
    
    const allVisible = cards.every(c => c.isVisible); 
    const toggleBtn = document.getElementById('btn-toggle-all'); 
    toggleBtn.innerHTML = allVisible ? '❎ 전체 해제' : '☑️ 전체 선택'; 
    toggleBtn.onclick = () => toggleAllCards(!allVisible);
    
    for(const [cat, items] of Object.entries(groups)) {
        const allHidden = items.every(c => !c.isVisible); 
        const catDiv = document.createElement('div'); 
        catDiv.className = 'category-section'; 
        items.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0));
        
        const isCollapsed = collapsedCategories[cat];
        
        catDiv.innerHTML = `<div class="category-header" onclick="toggleCatCollapse('${cat}')"><span>${cat} (${items.length}) ${isCollapsed?'▼':'▲'}</span><button class="icon-action-btn ${!allHidden?'active':''}" onclick="event.stopPropagation(); toggleCategory('${cat}')">${!allHidden ? '<svg style="width:1.2rem; height:1.2rem" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : '<svg style="width:1.2rem; height:1.2rem" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'}</button></div><div class="category-list ${isCollapsed ? 'collapsed' : ''}">${items.map(c => { 
            
            // ✏️ [복구됨] 내용이 있는지 확인하는 로직
            const u = userData[c.id] || {}; 
            const hasContent = Object.keys(u).some(k => k.endsWith('_v') && u[k] && u[k].replace(/<[^>]*>/g, '').trim().length > 0);
            
            const total = (u.o||0) + (u.x||0); 
            let badgeClass = 'score-gray'; 
            if(total > 0) { const rate = (u.o||0) / total; if(rate >= 0.8) badgeClass = 'score-green'; else if(rate >= 0.5) badgeClass = 'score-yellow'; else badgeClass = 'score-red'; } 
            const badgeText = total > 0 ? total : '-'; 
            
            // ✏️ 버튼 클래스에 ${hasContent ? 'filled' : ''} 추가됨
            return `<div class="list-item ${!c.isVisible ? 'hidden' : ''}"><div class="item-left"><span class="title">${c.title}</span></div><div class="item-right"><span class="score-badge ${badgeClass}">${badgeText}</span><div class="list-actions"><button class="icon-action-btn edit ${hasContent ? 'filled' : ''}" onclick="openManagerCardPreview(${c.id})"><svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button class="icon-action-btn ${c.isVisible?'active':''}" onclick="toggleCard(${c.id})">${c.isVisible ? '<svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>' : '<svg style="width:1rem; height:1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>'}</button></div></div></div>`; }).join('')}</div>`; list.appendChild(catDiv);
    }
}
function toggleCatCollapse(cat) { collapsedCategories[cat] = !collapsedCategories[cat]; saveCats(); renderManager(); }
function toggleCard(id) { const c = cards.find(x => x.id === id); if(c) { c.isVisible = !c.isVisible; saveCards(); renderManager(); } }
function toggleCategory(cat) { const items = cards.filter(c => c.cat === cat); const newState = !items.some(c => c.isVisible); items.forEach(c => c.isVisible = newState); saveCards(); renderManager(); }
function toggleAllCards(state) { cards.forEach(c => c.isVisible = state); saveCards(); renderManager(); }
function renderMockTree() { const root = document.getElementById('mock-tree-root'); root.innerHTML = ''; const groups = {}; cards.forEach(c => { if(!groups[c.cat]) groups[c.cat] = []; groups[c.cat].push(c); }); for(const [cat, items] of Object.entries(groups)) { items.sort((a,b) => parseInt(a.title.match(/^\d+/)?.[0]||0) - parseInt(b.title.match(/^\d+/)?.[0]||0)); const catDiv = document.createElement('div'); catDiv.className = 'tree-cat'; const checkedCount = items.filter(c => c.isVisible).length; catDiv.innerHTML = `<div class="tree-cat-head" onclick="toggleTreeCat(this)"><input type="checkbox" class="tree-chk-cat" onclick="event.stopPropagation(); checkCat(this)" ${checkedCount>0?'checked':''}><label>${cat} (${items.length})</label><span style="font-size:0.8rem; color:#cbd5e1;">▼</span></div><div class="tree-items">${items.map(c => `<div class="tree-item"><input type="checkbox" class="tree-chk-item" value="${c.id}" ${c.isVisible?'checked':''}><label onclick="this.previousElementSibling.click()">${c.title}</label></div>`).join('')}</div>`; root.appendChild(catDiv); } }
function toggleTreeCat(el) { el.nextElementSibling.classList.toggle('open'); el.querySelector('span').innerText = el.nextElementSibling.classList.contains('open') ? '▲' : '▼'; }
function checkCat(el) { el.parentElement.nextElementSibling.querySelectorAll('.tree-chk-item').forEach(i => i.checked = el.checked); }
function toggleAllMockTree() { const all = document.querySelectorAll('#mock-tree-root input[type="checkbox"]'); const state = Array.from(all).some(c => !c.checked); all.forEach(c => c.checked = state); }
function startMockExam() { const chks = document.querySelectorAll('.tree-chk-item:checked'); if(chks.length === 0) { alert("범위를 선택해주세요."); return; } const num = parseInt(document.getElementById('mock-num').value) || 5; const selectedIds = Array.from(chks).map(c => parseInt(c.value)); const selectedCards = cards.filter(c => selectedIds.includes(c.id)); const cats = {}; selectedCards.forEach(c => { if(!cats[c.cat]) cats[c.cat] = []; cats[c.cat].push(c); }); let pool = []; const catKeys = Object.keys(cats).sort(() => Math.random() - 0.5); catKeys.forEach(k => { if(cats[k].length > 0) { const idx = Math.floor(Math.random() * cats[k].length); pool.push(cats[k][idx]); cats[k].splice(idx, 1); } }); let remaining = num - pool.length; let leftovers = []; Object.values(cats).forEach(arr => leftovers.push(...arr)); if(remaining > 0 && leftovers.length > 0) { leftovers.sort(() => Math.random() - 0.5); pool.push(...leftovers.slice(0, remaining)); } else if (remaining < 0) { pool = pool.slice(0, num); } pool.sort(() => Math.random() - 0.5); currentMode = 'mock'; studyDeck = pool; currentIndex = 0; mockResults = []; document.getElementById('study-view').classList.add('active'); document.getElementById('mock-setup-view').classList.remove('active'); renderCard(); showToast(`${pool.length}문제 퀴즈 시작!`); }
function showMockResult() { 
    switchMode('mock-result'); 
    const correctCount = mockResults.filter(r => r.result).length; 
    const total = mockResults.length;
    const score = Math.round((correctCount / total) * 100);
    
    document.getElementById('result-score-text').innerText = `${correctCount} / ${total}`;
    
    let msg = "잘했어요!";
    if(score === 100) msg = "🎉 완벽해요! 모든 문제를 맞췄습니다!";
    else if(score >= 80) msg = "👍 아주 훌륭해요! 조금만 더 하면 만점!";
    else if(score >= 50) msg = "💪 힘내세요! 오답을 꼭 복습하세요.";
    else msg = "🔥 더 분발해야 해요! 기본기를 다져보세요.";
    document.getElementById('result-msg').innerText = msg;

    const hasWrong = total - correctCount > 0;
    document.getElementById('retry-wrong-btn-area').style.display = hasWrong ? 'block' : 'none';

    document.getElementById('result-list').innerHTML = mockResults.map(r => { const c = cards.find(x => x.id === r.id); return `<div class="result-item" onclick="reviewMockCard(${c.id})"><span class="res-badge ${r.result?'res-o':'res-x'}">${r.result?'O':'X'}</span><span style="flex:1; font-weight:600;">${c.title}</span><span style="color:#cbd5e1;">&gt;</span></div>`; }).join(''); 
}
function retryWrongAnswers() {
    const wrongIds = mockResults.filter(r => !r.result).map(r => r.id);
    if(wrongIds.length === 0) return;
    const pool = cards.filter(c => wrongIds.includes(c.id));
    currentMode = 'mock'; studyDeck = pool; currentIndex = 0; mockResults = [];
    document.getElementById('study-view').classList.add('active'); document.getElementById('mock-result-view').classList.remove('active');
    renderCard(); showToast(`${pool.length}문제 재도전 시작!`);
}
function reviewMockCard(id) { const c = cards.find(x => x.id === id); currentMode = 'review'; studyDeck = [c]; currentIndex = 0; switchMode('study'); renderCard(); }
function returnToResults() { switchMode('mock-result'); }
function openManagerCardPreview(id) { editTargetId = id; const card = cards.find(c => c.id === id); document.getElementById('manager-preview-title').innerText = card.title; const uData = userData[id] || {}; const active = uData.activeFields || ALL_FIELDS; document.querySelectorAll('.field-chip').forEach(chip => chip.classList.toggle('active', active.includes(chip.innerText))); renderBack(card, 'manager-preview-form'); document.getElementById('manager-preview-modal').classList.add('open'); checkEditHelp(); }
function toggleField(chip, code) { chip.classList.toggle('active'); const uData = userData[editTargetId] || {}; let active = uData.activeFields || [...ALL_FIELDS]; if(chip.classList.contains('active')) { if(!active.includes(code)) active.push(code); } else { active = active.filter(x => x !== code); } active.sort((a,b) => ALL_FIELDS.indexOf(a) - ALL_FIELDS.indexOf(b)); if(!userData[editTargetId]) userData[editTargetId] = {}; userData[editTargetId].activeFields = active; saveUserData(); renderBack(cards.find(c => c.id === editTargetId), 'manager-preview-form'); }
function openModal(code) { const isManager = document.getElementById('manager-preview-modal').classList.contains('open'); if(!isManager) editTargetId = studyDeck[currentIndex].id; const uData = userData[editTargetId] || {}; document.getElementById('modal-field-key').value = code; document.getElementById('modal-editor-key').innerHTML = uData[code+'_k'] || ''; document.getElementById('modal-editor-val').innerHTML = uData[code+'_v'] || ''; document.getElementById('input-modal').classList.add('open'); }
function closeModal() { document.getElementById('input-modal').classList.remove('open'); }
function execCmd(cmd) { document.execCommand(cmd, false, null); }
function execColor(color) { document.execCommand('foreColor', false, color); }


/* 글자 크기 + 글씨체 통일 함수 */
function setFontSize(size) {
    // 1. 먼저 글씨체를 깔끔하게(Pretendard) 바꿉니다.
    document.execCommand('fontName', false, 'Pretendard');
    // 2. 그 다음 크기를 바꿉니다.
    document.execCommand('fontSize', false, size);
}


// ✅ 형광펜 토글 (같은 색이면 제거, 다른 색이면 적용/변경)
function toggleHighlight(color) {
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;

  const range = sel.getRangeAt(0);
  if (range.collapsed) return;

  const COLORS = {
    yellow: '#fff9c4',
    green:  '#dcedc8'
  };
  const targetColor = COLORS[color] || COLORS.yellow;

  // 브라우저별 지원: hiliteColor가 안 되면 backColor 사용 (특히 Safari 대응)
  const cmd = document.queryCommandSupported && document.queryCommandSupported('hiliteColor')
    ? 'hiliteColor'
    : 'backColor';

  // 현재 선택영역이 "같은 색 형광펜" 위에 있는지 판단
  const isSame = selectionHasSameBgColor(sel, targetColor);

  if (isSame) {
    // ✅ 같은 색이면 "제거" (투명으로 칠한 뒤, 불필요 span 정리)
    document.execCommand(cmd, false, 'transparent');
    cleanupTransparentHighlightSpans(getClosestEditable(sel.anchorNode));
  } else {
    // ✅ 아니면 적용/변경
    document.execCommand(cmd, false, targetColor);
  }
}

// ---- 헬퍼들 ----

function selectionHasSameBgColor(sel, targetHex) {
  const targetRgb = toRgb(targetHex);

  const a = nearestBgSpan(sel.anchorNode);
  const b = nearestBgSpan(sel.focusNode);

  // anchor/focus 둘 중 하나라도 같은 색이면 "같은 색으로 칠해진 상태"로 간주
  return (a && colorsEqual(getComputedStyle(a).backgroundColor, targetRgb)) ||
         (b && colorsEqual(getComputedStyle(b).backgroundColor, targetRgb));
}

function nearestBgSpan(node) {
  let el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
  while (el && el !== document.body) {
    if (el.nodeType === 1) {
      const bg = getComputedStyle(el).backgroundColor;
      if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') return el;
    }
    el = el.parentElement;
  }
  return null;
}

function toRgb(colorStr) {
  const tmp = document.createElement('span');
  tmp.style.backgroundColor = colorStr;
  document.body.appendChild(tmp);
  const rgb = getComputedStyle(tmp).backgroundColor;
  document.body.removeChild(tmp);
  return rgb;
}

function colorsEqual(a, b) {
  // 공백 차이 등만 정리해서 비교
  return String(a).replace(/\s+/g, '') === String(b).replace(/\s+/g, '');
}

function getClosestEditable(node) {
  let el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
  while (el && el !== document.body) {
    if (el.isContentEditable) return el;
    el = el.parentElement;
  }
  return document.body;
}

function cleanupTransparentHighlightSpans(root) {
  // transparent/rgba(0,0,0,0) 같은 span들 정리(껍데기만 남는 거 방지)
  const spans = root.querySelectorAll('span');
  spans.forEach(span => {
    const bg = getComputedStyle(span).backgroundColor;
    if (bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
      // span 풀기
      const parent = span.parentNode;
      while (span.firstChild) parent.insertBefore(span.firstChild, span);
      parent.removeChild(span);
    }
  });
}

function saveFieldData() { 
    const code = document.getElementById('modal-field-key').value; 
    if(!userData[editTargetId]) userData[editTargetId] = {}; 
    userData[editTargetId][code+'_k'] = document.getElementById('modal-editor-key').innerHTML; 
    userData[editTargetId][code+'_v'] = document.getElementById('modal-editor-val').innerHTML; 
    
    saveUserData(); 
    
    // 카드 미리보기 갱신
    if(document.getElementById('manager-preview-modal').classList.contains('open')) renderBack(cards.find(c => c.id === editTargetId), 'manager-preview-form'); 
    // 학습 모드 갱신
    if(document.getElementById('study-view').classList.contains('active') && studyDeck[currentIndex] && studyDeck[currentIndex].id === editTargetId) renderBack(studyDeck[currentIndex], 'card-back-form'); 
    
    // ✅ [추가됨] 목록 화면도 즉시 갱신 (파란 연필 바로 반영)
    if(document.getElementById('manager-view').classList.contains('active')) renderManager();

    closeModal(); 
    showToast("저장되었습니다."); 
}
// --- 데이터 내보내기/가져오기 (클립보드 방식) ---

// 1. 내보내기 (복사하기)
async function exportDataToClipboard() {
    const backupData = {
        cards: cards,
        userData: userData,
        cats: collapsedCategories,
        date: new Date().toLocaleString()
    };

    const jsonString = JSON.stringify(backupData);

    try {
        await navigator.clipboard.writeText(jsonString);
        alert("데이터가 클립보드에 복사되었습니다!\n\n카카오톡이나 메모장에 '붙여넣기'하여 보관하세요.");
    } catch (err) {
        const textArea = document.getElementById('import-text-area');
        textArea.value = jsonString;
        document.querySelector('details').open = true;
        textArea.select();
        alert("자동 복사에 실패했습니다.\n아래 텍스트 상자의 내용을 '전체 선택' -> '복사' 하세요.");
    }
}

// 2. 가져오기 (붙여넣기 - 자동)
async function importDataFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        if (!text) {
            alert("클립보드에 복사된 내용이 없습니다.");
            return;
        }
        processDataRestoration(text);
    } catch (err) {
        console.error(err);
        document.querySelector('details').open = true;
        document.getElementById('import-text-area').focus();
        alert("클립보드 접근 권한이 없습니다.\n아래 입력창에 백업 코드를 직접 붙여넣고 '텍스트로 복원하기'를 눌러주세요.");
    }
}

// 3. 가져오기 (수동 입력창 사용)
function importFromTextArea() {
    const text = document.getElementById('import-text-area').value;
    if (!text.trim()) {
        alert("백업 코드를 입력해주세요.");
        return;
    }
    processDataRestoration(text);
}

// 4. 실제 데이터 복원 로직
function processDataRestoration(jsonString) {
    try {
        const data = JSON.parse(jsonString);
        if (!data.cards || !data.userData) {
            throw new Error("유효하지 않은 데이터 형식입니다.");
        }
        if (confirm(`백업 데이터(${data.date || '날짜 없음'})로 복원하시겠습니까?\n현재 진행 상황은 덮어씌워집니다.`)) {
            cards = data.cards;
            userData = data.userData;
            collapsedCategories = data.cats || {};
            saveCards();
            saveUserData();
            saveCats();
            alert("✅ 복원이 완료되었습니다.");
            location.reload();
        }
    } catch (e) {
        console.error(e);
        alert("데이터 복원에 실패했습니다.\n올바른 백업 코드가 아니거나 형식이 손상되었습니다.");
    }
}
function resetData() { if(confirm("초기화하시겠습니까? (데이터 삭제)")) { localStorage.clear(); location.reload(); } }
function openTimerModal() { document.getElementById('timer-modal').classList.add('open'); }
function closeTimerModal() { document.getElementById('timer-modal').classList.remove('open'); }
function setTimerOption(mode) { if(mode==='1min') { timerTime=60; isInfinite=false; } else if(mode==='unlimited') isInfinite=true; else { const v=prompt("시간(초):", "60"); if(v) {timerTime=parseInt(v); isInfinite=false;} } stopTimer(); timeLeft=isInfinite?999:timerTime; updateTimerUI(); closeTimerModal(); if(document.getElementById('study-view').classList.contains('active') && studyDeck.length > 0) startTimer(); }
function startTimer() { 
    stopTimer(); 
    if(!isInfinite) timeLeft=timerTime; 
    updateTimerUI; 
    timerInterval = setInterval(() => { 
        if(isInfinite) return; 
        timeLeft--; 
        updateTimerUI(); 
        if(timeLeft<=0) { 
            stopTimer(); 
            document.getElementById('card-wrapper').classList.add('shaking'); 
        } 
    }, 1000); 
}
function stopTimer() { clearInterval(timerInterval); document.getElementById('timer-badge').classList.remove('urgent'); }
function updateTimerUI() { 
    const badge = document.getElementById('timer-badge');
    document.getElementById('timer-text').innerHTML = isInfinite ? '&infin;' : timeLeft; 
    if(!isInfinite && timeLeft <= 10) badge.classList.add('urgent');
    else badge.classList.remove('urgent');
}


init();
</script>
</body>
</html>
